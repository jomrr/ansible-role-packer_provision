---
# role: ansible-role-packer-provision
# file: tasks/main.yml

- name: "Role packer_provision | Set os_family dependent variables"
  ansible.builtin.include_vars: '{{ ansible_os_family | lower }}.yml'

- name: "Role packer_provision | Set distribution dependent variables"
  ansible.builtin.include_vars: "{{ item }}"
  vars:
    params:
      files:
        - '{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml'
        - '{{ ansible_distribution | lower }}.yml'
        - '{{ ansible_os_family | lower }}-{{ ansible_distribution_major_version }}.yml'
      paths:
        - 'vars'
      skip: true
  loop: "{{ query('first_found', params, errors='ignore') }}"

- name: "Role packer_provision | Run provision commands"
  ansible.builtin.shell: "{{ item }}"
  loop: "{{ packer_provision_commands | default([], true) }}"
  changed_when: false
  tags: ['skip_ansible_lint']

- name: "Role packer_provision | Include tasks for package manager"
  ansible.builtin.include_tasks: "{{ ansible_pkg_mgr }}.yml"

- name: "Role packer_provision | Include tasks for ansible_ssh_user"
  ansible.builtin.include_tasks: user.yml

- name: "Role packer_provision | Include tasks for removing swap"
  ansible.builtin.include_tasks: swap.yml

- name: "Role packer_provision | Run cleanup commands"
  ansible.builtin.shell: "{{ item }}"
  loop: "{{ packer_provision_commands_clean | default([], true) }}"
  changed_when: false
  tags: ['skip_ansible_lint']
